#! /bin/sh -f
#
#  Replaces floating point numbers with XXX and then does a diff
#
#
# Method to print out general and script specific options
#
print_usage() {

cat >&2 <<EOF
Usage: $0 [options] file1 file2
Replaces floating point numbers with XXX and then does a diff
file1 is typically "expected result"

OPTIONS
  -j ............. just use diff without modifying numbers
  -h ............. print this message
  -f ............. filter file1 with commands; e.g., 'sort -nr'
  -F ............. filter file2 with commands; e.g., 'grep -v foo | grep -v bar'
  -k ............. keep the filter files -- do not delete
EOF
  exit $1
}
# Unset some environment variables to avoid problems on cygwin
# See: https://cygwin.com/pipermail/cygwin/2020-March/244153.html
# Suspect that the problems are with gitlab's environment variables
unset CI_ENVIRONMENT_NAME
unset CI_COMMIT_BEFORE_SHA
unset CI_COMMIT_DESCRIPTION
unset CI_COMMIT_MESSAGE
unset CI_CONFIG_PATH

# parse options -- using getopts because it is so easily extensible
justdiff=false
filter=false          # File2
filter_output=false   # File1
keep_files=false
diffargs=""
while getopts "f:F:hjJ:kmM" opt
do
  case $opt in
    f ) filter_output=true;  filter_output_cmd=$OPTARG ;;
    F ) filter=true;  filter_cmd=$OPTARG ;;
    j ) justdiff=true ;;
    J ) justdiff=true;  diffargs=$OPTARG;;
    k ) keep_files=true;;
    h ) print_usage 0;;
  esac
done
shift "$(( $OPTIND - 1 ))"

if [ $# -lt 2 ]; then
  echo petscdiff: Error! needs two arguments
  print_usage 1
fi

# Filter a file and sort output into a file with a unique suffix
filter_suffix=".filter_tmp"
filter_file() {
  file="$1"
  fcmds="$2"
  eval "cat ${file} | ${fcmds} > ${file}${filter_suffix}"
}

if [ "x${RM}" = "x" ]; then RM="rm"; fi
if [ "x${SED}" = "x" ]; then SED="sed"; fi
if [ "x${DIFF}" = "x" ]; then DIFF="diff -w";
elif [ "`basename ${DIFF}`" = "petscdiff" ]; then DIFF="diff -w";
fi

if [ "x${1}" = "x-" ]; then
    file1=`mktemp -t petscdiff.XXXXXX` ;
    $(cat /dev/stdin > ${file1})
elif [ -f ${1} ]; then
    file1=${1}
else
  echo petscdiff: Error! file1 existence check failed: "${1}"
  exit 1
fi

if [ -f ${2} ]; then
    file2=${2}
else
  echo petscdiff: Error! file2 existence check failed: "${2}"
  exit 1
fi

if ${filter}; then
      filter_file "${file2}" "${filter_cmd}" 
      file2="${file2}${filter_suffix}"  # Will need to remove later
fi
result_file=${file1}
if ${filter_output}; then
      filter_file "${file1}" "${filter_output_cmd}" 
      file1="${file1}${filter_suffix}"  # Will need to remove later
fi

if ! ${justdiff}; then
    tmpA=`mktemp -t petscdiffA.XXXXXX` ;
    tmpB=`mktemp -t petscdiffB.XXXXXX` ;

    ${SED} "s/< [-+ ]*[0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" ${file1} | ${SED} "s/[-+ ]*[-]*[0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" | ${SED}  "s/[-+ ]*[-]*[0-9][0-9]*\.[0-9]*/XXX/g" | ${SED} "s/ \*\*\*\*\*\*\*\*\* /XXX/g" > ${tmpA}

    ${SED} "s/< [-+ ]*[0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" ${file2} | ${SED} "s/[-+ ]*[-]*[0-9][0-9]*\.*[0-9]*[eE][-+][0-9][0-9]*/XXX/g" | ${SED}  "s/[-+ ]*[-]*[0-9][0-9]*\.[0-9]*/XXX/g" | ${SED} "s/ \*\*\*\*\*\*\*\*\* /XXX/g" > ${tmpB}
    ${DIFF} ${tmpA} ${tmpB} > /dev/null
    if [ $? -ne 0 ]; then
      ${DIFF}  ${file1} ${file2}
      err=1
    else
      err=0
    fi
    ${RM} -f ${tmpA} ${tmpB}
else
    ${DIFF} ${diffargs} ${file1} ${file2}
    err=$?
fi

if [ "x${1}" = "x-" ]; then
  ${RM} -f ${file1}
fi

# For debugging filters, it is useful to be able to keep the files
if ! ${keep_files}; then
  if ${filter}; then
        ${RM} -f ${file2}  # Temporary file.  See above
  fi
  if ${filter_output}; then
        ${RM} -f ${file1}  # Temporary file.  See above
  fi
fi

exit ${err};
